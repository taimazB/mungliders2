const bathymetryMinOrg = -10850;
var bathymetryMin = bathymetryMinOrg;
const bathymetryMaxOrg = 0;
var bathymetryMax = bathymetryMaxOrg;

function bathymetryInit() {
    $("#cnvBathymetry").css('display', 'block');

    // bnds = { _ne: { lat: 30, lng: -50 }, _sw: { lat: 20, lng: -40 } }

    imgBathymetry.src = `topo/bathymetry.jpg`;
    imgBathymetry.onload = () => {
        var top = imgBathymetry.naturalHeight * (1 - (lat2y(bnds._ne.lat) + lat2y(80)) / (2 * lat2y(80)));
        var bottom = imgBathymetry.naturalHeight * (1 - (lat2y(bnds._sw.lat) + lat2y(80)) / (2 * lat2y(80)));
        var left = imgBathymetry.naturalWidth * (bnds._sw.lng + 180) / 360;
        var right = imgBathymetry.naturalWidth * (bnds._ne.lng + 180) / 360;
        var imgWidth = right - left;
        var imgHeight = bottom - top;


        // --- Crop image for the visible part of map
        cnvBathymetryTmp.width = mapWidth;                        // size of new image
        cnvBathymetryTmp.height = mapHeight;

        // --- Draw part of the first image onto the new canvas
        ctxBathymetryTmp = cnvBathymetryTmp.getContext('2d');
        ctxBathymetryTmp.drawImage(imgBathymetry, left, top, imgWidth, imgHeight, 0, 0, cnvBathymetryTmp.width, cnvBathymetryTmp.height);
        imageData = ctxBathymetryTmp.getImageData(0, 0, mapWidth, mapHeight);
        const data = imageData.data;

        for (var i = 0; i < data.length; i += 4) {
            var rgb = colorPaletteBathymetry((1 - data[i] * 50 / (bathymetryMaxOrg - bathymetryMinOrg) - (bathymetryMin - bathymetryMinOrg) / (bathymetryMaxOrg - bathymetryMinOrg)) * (bathymetryMaxOrg - bathymetryMinOrg) / (bathymetryMax - bathymetryMin));
            data[i] = rgb[0]; // red
            data[i + 1] = rgb[1]; // green
            data[i + 2] = rgb[2]; // blue
        }

        // --- Draw part of the first image onto the new canvas
        ctxBathymetry.putImageData(imageData, 0, 0)
    }
}

function bathymetryMove() {
    // bnds = { _ne: { lat: 30, lng: -50 }, _sw: { lat: 20, lng: -40 } }

    var top = imgBathymetry.naturalHeight * (1 - (lat2y(bnds._ne.lat) + lat2y(80)) / (2 * lat2y(80)));
    var bottom = imgBathymetry.naturalHeight * (1 - (lat2y(bnds._sw.lat) + lat2y(80)) / (2 * lat2y(80)));
    var left = imgBathymetry.naturalWidth * (bnds._sw.lng + 180) / 360;
    var right = imgBathymetry.naturalWidth * (bnds._ne.lng + 180) / 360;
    var imgWidth = right - left;
    var imgHeight = bottom - top;

    // --- Crop image for the visible part of map
    cnvBathymetryTmp.width = mapWidth;                        // size of new image
    cnvBathymetryTmp.height = mapHeight;

    // --- Draw part of the first image onto the new canvas
    ctxBathymetryTmp.drawImage(imgBathymetry, left, top, imgWidth, imgHeight, 0, 0, cnvBathymetryTmp.width, cnvBathymetryTmp.height);
    imageData = ctxBathymetryTmp.getImageData(0, 0, mapWidth, mapHeight);
    var data = imageData.data;

    for (var i = 0; i < data.length; i += 4) {
        var rgb = colorPaletteBathymetry((1 - data[i] * 50 / (bathymetryMaxOrg - bathymetryMinOrg) - (bathymetryMin - bathymetryMinOrg) / (bathymetryMaxOrg - bathymetryMinOrg)) * (bathymetryMaxOrg - bathymetryMinOrg) / (bathymetryMax - bathymetryMin));
        data[i] = rgb[0]; // red
        data[i + 1] = rgb[1]; // green
        data[i + 2] = rgb[2]; // blue
    }

    // --- Draw part of the first image onto the new canvas
    ctxBathymetry.putImageData(imageData, 0, 0)
}


///////////////////////////////////////////----------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
//----------------------------------------- COLORBAR -----------------------------------------\\
const colorsBathymetry = [[8.0, 29.0, 88.0], [8.909803921568626, 29.72156862745098, 89.88235294117648], [9.819607843137256, 30.44313725490196, 91.76470588235293], [10.729411764705882, 31.16470588235294, 93.6470588235294], [11.639215686274511, 31.88627450980392, 95.5294117647059], [12.549019607843137, 32.6078431372549, 97.41176470588235], [13.458823529411763, 33.32941176470588, 99.29411764705883], [14.368627450980393, 34.05098039215686, 101.1764705882353], [15.27843137254902, 34.77254901960784, 103.05882352941175], [16.18823529411765, 35.49411764705882, 104.94117647058823], [17.098039215686274, 36.21568627450981, 106.82352941176471], [18.00784313725493, 36.937254901960806, 108.70588235294123], [18.91764705882353, 37.65882352941176, 110.58823529411765], [19.827450980392157, 38.38039215686274, 112.47058823529412], [20.737254901960785, 39.101960784313725, 114.35294117647058], [21.647058823529413, 39.8235294117647, 116.23529411764707], [22.55686274509804, 40.54509803921569, 118.11764705882354], [23.466666666666665, 41.26666666666667, 120.0], [24.376470588235296, 41.98823529411764, 121.88235294117648], [25.286274509803924, 42.70980392156862, 123.76470588235294], [26.196078431372552, 43.431372549019606, 125.6470588235294], [27.105882352941176, 44.15294117647059, 127.5294117647059], [28.015686274509804, 44.87450980392157, 129.41176470588238], [28.92549019607843, 45.59607843137255, 131.2941176470588], [29.835294117647063, 46.317647058823525, 133.1764705882353], [30.745098039215687, 47.03921568627451, 135.0588235294118], [31.654901960784315, 47.76078431372549, 136.94117647058823], [32.56470588235297, 48.482352941176494, 138.82352941176478], [33.47450980392158, 49.20392156862745, 140.7058823529412], [34.3843137254902, 49.925490196078435, 142.58823529411765], [35.294117647058826, 50.647058823529406, 144.47058823529414], [36.20392156862745, 51.36862745098039, 146.3529411764706], [36.98823529411765, 52.16470588235293, 148.07843137254903], [36.89411764705883, 53.482352941176465, 148.7058823529412], [36.800000000000004, 54.8, 149.33333333333334], [36.70588235294118, 56.11764705882353, 149.9607843137255], [36.61176470588236, 57.43529411764706, 150.58823529411765], [36.51764705882353, 58.75294117647059, 151.21568627450984], [36.42352941176471, 60.07058823529412, 151.84313725490196], [36.32941176470589, 61.38823529411765, 152.47058823529414], [36.23529411764706, 62.70588235294118, 153.09803921568627], [36.14117647058824, 64.0235294117647, 153.72549019607845], [36.04705882352941, 65.34117647058824, 154.35294117647058], [35.95294117647059, 66.65882352941179, 154.9803921568628], [35.858823529411765, 67.97647058823529, 155.6078431372549], [35.76470588235294, 69.29411764705881, 156.23529411764707], [35.67058823529412, 70.61176470588236, 156.86274509803923], [35.576470588235296, 71.92941176470589, 157.49019607843138], [35.482352941176465, 73.24705882352941, 158.11764705882354], [35.38823529411765, 74.56470588235295, 158.7450980392157], [35.294117647058826, 75.88235294117648, 159.37254901960785], [35.199999999999996, 77.2, 160.0], [35.10588235294118, 78.51764705882354, 160.62745098039215], [35.01176470588236, 79.83529411764707, 161.2549019607843], [34.917647058823526, 81.15294117647059, 161.8823529411765], [34.8235294117647, 82.47058823529413, 162.50980392156862], [34.72941176470589, 83.78823529411765, 163.1372549019608], [34.63529411764706, 85.10588235294118, 163.76470588235293], [34.54117647058823, 86.42352941176472, 164.3921568627451], [34.44705882352941, 87.74117647058829, 165.01960784313727], [34.35294117647059, 89.05882352941177, 165.64705882352942], [34.258823529411764, 90.3764705882353, 166.27450980392157], [34.16470588235294, 91.69411764705883, 166.90196078431373], [34.07058823529412, 93.01176470588236, 167.52941176470588], [33.96078431372549, 94.4, 168.18823529411765], [33.80392156862745, 96.0, 168.94117647058823], [33.64705882352941, 97.60000000000001, 169.69411764705882], [33.49019607843137, 99.2, 170.4470588235294], [33.333333333333336, 100.8, 171.20000000000002], [33.17647058823529, 102.4, 171.95294117647057], [33.01960784313726, 104.0, 172.70588235294116], [32.86274509803921, 105.6, 173.45882352941177], [32.705882352941174, 107.2, 174.21176470588233], [32.549019607843135, 108.8, 174.96470588235294], [32.3921568627451, 110.4, 175.71764705882353], [32.23529411764705, 112.00000000000006, 176.47058823529414], [32.07843137254902, 113.6, 177.2235294117647], [31.92156862745098, 115.2, 177.9764705882353], [31.76470588235294, 116.8, 178.72941176470587], [31.6078431372549, 118.39999999999999, 179.48235294117646], [31.45098039215686, 120.0, 180.23529411764707], [31.294117647058822, 121.6, 180.98823529411763], [31.137254901960784, 123.2, 181.74117647058824], [30.980392156862745, 124.8, 182.49411764705883], [30.823529411764707, 126.39999999999999, 183.2470588235294], [30.666666666666668, 128.0, 184.0], [30.50980392156863, 129.6, 184.75294117647059], [30.352941176470587, 131.20000000000002, 185.50588235294117], [30.19607843137255, 132.79999999999998, 186.25882352941176], [30.03921568627451, 134.4, 187.01176470588237], [29.88235294117647, 136.0, 187.76470588235293], [29.72549019607843, 137.60000000000005, 188.51764705882357], [29.56862745098039, 139.20000000000002, 189.27058823529413], [29.41176470588235, 140.79999999999998, 190.02352941176468], [29.254901960784313, 142.39999999999998, 190.7764705882353], [29.098039215686274, 144.0, 191.52941176470588], [29.423529411764697, 145.43529411764706, 192.0470588235294], [30.552941176470583, 146.59607843137252, 192.17254901960783], [31.682352941176465, 147.75686274509803, 192.29803921568626], [32.81176470588235, 148.91764705882352, 192.4235294117647], [33.94117647058823, 150.07843137254903, 192.54901960784315], [35.07058823529411, 151.23921568627452, 192.67450980392158], [36.199999999999996, 152.4, 192.8], [37.329411764705874, 153.5607843137255, 192.92549019607844], [38.45882352941176, 154.72156862745098, 193.05098039215687], [39.588235294117645, 155.88235294117646, 193.1764705882353], [40.71764705882352, 157.04313725490195, 193.3019607843137], [41.84705882352944, 158.2039215686275, 193.42745098039217], [42.97647058823528, 159.36470588235295, 193.5529411764706], [44.105882352941165, 160.52549019607844, 193.67843137254903], [45.23529411764705, 161.68627450980392, 193.80392156862746], [46.36470588235293, 162.8470588235294, 193.9294117647059], [47.49411764705882, 164.0078431372549, 194.05490196078432], [48.6235294117647, 165.16862745098038, 194.18039215686275], [49.752941176470586, 166.32941176470587, 194.30588235294118], [50.882352941176464, 167.49019607843138, 194.4313725490196], [52.01176470588234, 168.65098039215687, 194.55686274509804], [53.14117647058823, 169.81176470588235, 194.68235294117648], [54.27058823529411, 170.97254901960784, 194.8078431372549], [55.39999999999999, 172.13333333333333, 194.93333333333334], [56.52941176470588, 173.2941176470588, 195.05882352941177], [57.658823529411755, 174.4549019607843, 195.1843137254902], [58.78823529411764, 175.61568627450978, 195.30980392156863], [59.91764705882356, 176.77647058823536, 195.4352941176471], [61.047058823529404, 177.93725490196078, 195.56078431372552], [62.17647058823529, 179.09803921568627, 195.68627450980395], [63.30588235294117, 180.25882352941176, 195.81176470588238], [64.43529411764706, 181.41960784313724, 195.93725490196078], [65.97254901960784, 182.36078431372547, 195.85882352941178], [67.91764705882353, 183.08235294117648, 195.5764705882353], [69.86274509803921, 183.80392156862746, 195.2941176470588], [71.80784313725489, 184.52549019607844, 195.01176470588237], [73.7529411764706, 185.24705882352941, 194.7294117647059], [75.69803921568631, 185.96862745098042, 194.4470588235294], [77.64313725490196, 186.69019607843137, 194.16470588235293], [79.58823529411765, 187.41176470588238, 193.88235294117646], [81.53333333333335, 188.13333333333335, 193.60000000000002], [83.47843137254901, 188.85490196078433, 193.31764705882352], [85.4235294117647, 189.5764705882353, 193.03529411764706], [87.3686274509804, 190.29803921568626, 192.75294117647059], [89.31372549019608, 191.01960784313727, 192.47058823529414], [91.25882352941179, 191.74117647058824, 192.18823529411765], [93.20392156862745, 192.46274509803922, 191.90588235294118], [95.14901960784313, 193.1843137254902, 191.6235294117647], [97.09411764705882, 193.90588235294118, 191.3411764705882], [99.03921568627452, 194.62745098039215, 191.05882352941177], [100.9843137254902, 195.34901960784316, 190.7764705882353], [102.92941176470589, 196.0705882352941, 190.49411764705883], [104.87450980392157, 196.79215686274512, 190.21176470588233], [106.81960784313729, 197.5137254901961, 189.92941176470586], [108.76470588235294, 198.23529411764704, 189.64705882352942], [110.70980392156862, 198.95686274509805, 189.36470588235295], [112.65490196078431, 199.67843137254903, 189.08235294117645], [114.6, 200.4, 188.79999999999998], [116.54509803921569, 201.12156862745098, 188.51764705882354], [118.49019607843137, 201.84313725490196, 188.23529411764704], [120.43529411764705, 202.56470588235294, 187.95294117647057], [122.38039215686278, 203.28627450980395, 187.6705882352941], [124.32549019607843, 204.0078431372549, 187.38823529411764], [126.27058823529413, 204.7294117647059, 187.10588235294117], [128.41176470588238, 205.54901960784315, 186.86274509803923], [130.67058823529413, 206.42745098039217, 186.64313725490194], [132.92941176470592, 207.30588235294118, 186.4235294117647], [135.18823529411767, 208.1843137254902, 186.20392156862744], [137.4470588235294, 209.06274509803922, 185.98431372549018], [139.70588235294122, 209.94117647058826, 185.76470588235293], [141.96470588235294, 210.81960784313725, 185.5450980392157], [144.2235294117647, 211.6980392156863, 185.32549019607845], [146.48235294117646, 212.5764705882353, 185.10588235294117], [148.74117647058824, 213.4549019607843, 184.8862745098039], [151.0, 214.33333333333334, 184.66666666666666], [153.25882352941176, 215.21176470588236, 184.4470588235294], [155.51764705882354, 216.09019607843135, 184.22745098039215], [157.77647058823533, 216.96862745098042, 184.0078431372549], [160.03529411764706, 217.8470588235294, 183.78823529411764], [162.29411764705884, 218.72549019607843, 183.5686274509804], [164.5529411764706, 219.60392156862747, 183.34901960784313], [166.81176470588235, 220.48235294117646, 183.12941176470588], [169.0705882352941, 221.36078431372547, 182.90980392156862], [171.3294117647059, 222.23921568627452, 182.6901960784314], [173.58823529411765, 223.1176470588235, 182.47058823529412], [175.84705882352944, 223.99607843137258, 182.25098039215686], [178.1058823529412, 224.87450980392157, 182.0313725490196], [180.36470588235295, 225.75294117647059, 181.81176470588235], [182.6235294117647, 226.63137254901963, 181.5921568627451], [184.8823529411765, 227.50980392156862, 181.37254901960787], [187.14117647058825, 228.38823529411764, 181.1529411764706], [189.4, 229.26666666666668, 180.93333333333334], [191.6588235294118, 230.1450980392157, 180.71372549019608], [193.91764705882358, 231.0235294117647, 180.49411764705883], [196.1764705882353, 231.90196078431373, 180.27450980392157], [198.43529411764706, 232.78039215686275, 180.05490196078435], [199.89411764705883, 233.35294117647058, 179.9294117647059], [201.08627450980393, 233.8235294117647, 179.83529411764707], [202.27843137254902, 234.29411764705884, 179.74117647058824], [203.47058823529412, 234.76470588235293, 179.64705882352942], [204.6627450980392, 235.23529411764704, 179.5529411764706], [205.8549019607843, 235.70588235294116, 179.45882352941177], [207.0470588235294, 236.17647058823528, 179.36470588235295], [208.23921568627452, 236.64705882352942, 179.27058823529413], [209.4313725490196, 237.1176470588235, 179.1764705882353], [210.6235294117647, 237.58823529411765, 179.08235294117645], [211.81568627450983, 238.05882352941177, 178.98823529411763], [213.0078431372549, 238.52941176470586, 178.8941176470588], [214.2, 239.0, 178.8], [215.39215686274508, 239.47058823529412, 178.7058823529412], [216.5843137254902, 239.94117647058823, 178.61176470588236], [217.7764705882353, 240.41176470588235, 178.51764705882354], [218.96862745098042, 240.88235294117646, 178.42352941176472], [220.16078431372551, 241.35294117647058, 178.3294117647059], [221.3529411764706, 241.8235294117647, 178.23529411764707], [222.5450980392157, 242.29411764705884, 178.14117647058822], [223.7372549019608, 242.76470588235293, 178.0470588235294], [224.9294117647059, 243.23529411764707, 177.95294117647057], [226.12156862745098, 243.70588235294116, 177.85882352941175], [227.31372549019608, 244.17647058823528, 177.76470588235293], [228.50588235294117, 244.64705882352942, 177.6705882352941], [229.69803921568626, 245.1176470588235, 177.57647058823528], [230.8901960784314, 245.58823529411765, 177.4823529411765], [232.08235294117648, 246.05882352941177, 177.38823529411766], [233.27450980392157, 246.52941176470586, 177.29411764705884], [234.46666666666667, 247.0, 177.2], [235.6588235294118, 247.47058823529412, 177.10588235294117], [236.85098039215686, 247.94117647058823, 177.01176470588234], [237.49411764705883, 248.1921568627451, 178.09803921568627], [238.05882352941177, 248.41176470588235, 179.35294117647058], [238.6235294117647, 248.6313725490196, 180.6078431372549], [239.18823529411765, 248.85098039215686, 181.8627450980392], [239.75294117647059, 249.0705882352941, 183.1176470588235], [240.31764705882352, 249.29019607843136, 184.37254901960782], [240.8823529411765, 249.50980392156862, 185.62745098039215], [241.4470588235294, 249.72941176470587, 186.88235294117646], [242.01176470588237, 249.94901960784316, 188.13725490196077], [242.57647058823528, 250.1686274509804, 189.39215686274508], [243.14117647058825, 250.38823529411764, 190.64705882352942], [243.70588235294116, 250.6078431372549, 191.90196078431373], [244.27058823529413, 250.82745098039214, 193.15686274509804], [244.83529411764707, 251.0470588235294, 194.41176470588235], [245.4, 251.26666666666668, 195.66666666666666], [245.96470588235294, 251.48627450980393, 196.921568627451], [246.52941176470588, 251.70588235294116, 198.17647058823528], [247.09411764705882, 251.9254901960784, 199.4313725490196], [247.6588235294118, 252.14509803921567, 200.68627450980392], [248.2235294117647, 252.36470588235295, 201.94117647058823], [248.78823529411767, 252.5843137254902, 203.19607843137254], [249.35294117647058, 252.80392156862746, 204.45098039215685], [249.91764705882355, 253.02352941176468, 205.70588235294116], [250.48235294117646, 253.24313725490194, 206.96078431372547], [251.04705882352943, 253.46274509803922, 208.21568627450978], [251.61176470588236, 253.68235294117648, 209.4705882352941], [252.1764705882353, 253.90196078431373, 210.72549019607843], [252.74117647058824, 254.12156862745098, 211.98039215686276], [253.30588235294118, 254.3411764705882, 213.23529411764707], [253.87058823529412, 254.5607843137255, 214.49019607843138], [254.43529411764706, 254.78039215686275, 215.7450980392157], [255.0, 255.0, 217.0]]

function colorPaletteBathymetry(c) {
    if (c < 0) {
        return colorsBathymetry[0];
    } else if (c < 1) {
        return colorsBathymetry[parseInt(c * 256)];
    } else {
        return colorsBathymetry[colorsBathymetry.length - 1];
    }
}


function adjustColorbarBathymetry(bathymetryMin, bathymetryMax, fnPalette) {
    var tmp;
    $("#bathymetryColorbar").css("background-image",
        `linear-gradient(to right, ${_.range(10).map(i => { return "rgb(" + fnPalette(i / 9) + ")" }).join()}`);

    $("#lbBathymetryColorbar0").html(bathymetryMin > -1000 ? bathymetryMin.toFixed(0) + " m" : (bathymetryMin / 1000).toFixed(1) + " km");
    tmp = (.75 * bathymetryMin + .25 * bathymetryMax); $("#lbBathymetryColorbar25").html(tmp > -1000 ? tmp.toFixed(0) + " m" : (tmp / 1000).toFixed(1) + " km");
    tmp = (.5 * bathymetryMin + .5 * bathymetryMax); $("#lbBathymetryColorbar50").html(tmp > -1000 ? tmp.toFixed(0) + " m" : (tmp / 1000).toFixed(1) + " km");
    tmp = (.25 * bathymetryMin + .75 * bathymetryMax); $("#lbBathymetryColorbar75").html(tmp > -1000 ? tmp.toFixed(0) + " m" : (tmp / 1000).toFixed(1) + " km");
    $("#lbBathymetryColorbar100").html(bathymetryMax < 1000 ? bathymetryMax.toFixed(0) + " m" : (bathymetryMax / 1000).toFixed(1) + " km");
}


adjustColorbarBathymetry(bathymetryMin, bathymetryMax, colorPaletteBathymetry);



function resetBathymetryMinMax() {
    bathymetryMin = bathymetryMinOrg;
    bathymetryMax = bathymetryMaxOrg;
}


$("#bathymetryMinUp").on("click", () => {
    if (bathymetryMin + 50 < bathymetryMax) { bathymetryMin += 50; }
    draw({ init: true });
    adjustColorbarBathymetry(bathymetryMin, bathymetryMax, colorPaletteBathymetry);
})

$("#bathymetryMinDown").on("click", () => {
    if (bathymetryMin - 50 >= bathymetryMinOrg) { bathymetryMin -= 50; }
    draw({ init: true });
    adjustColorbarBathymetry(bathymetryMin, bathymetryMax, colorPaletteBathymetry);
})

$("#bathymetryMaxUp").on("click", () => {
    if (bathymetryMax + 50 <= bathymetryMaxOrg) { bathymetryMax += 50; }
    draw({ init: true });
    adjustColorbarBathymetry(bathymetryMin, bathymetryMax, colorPaletteBathymetry);
})

$("#bathymetryMaxDown").on("click", () => {
    if (bathymetryMax - 50 > bathymetryMin) { bathymetryMax -= 50; }
    draw({ init: true });
    adjustColorbarBathymetry(bathymetryMin, bathymetryMax, colorPaletteBathymetry);
})

$("#btnResetMinMaxBathymetry").on("click", () => {
    resetBathymetryMinMax();
    draw({ init: false })
})
